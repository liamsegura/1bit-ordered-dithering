<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Image Ditherer</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 100vh;
        margin: 0;
        background-color: #f0f0f0;
      }

      .container {
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 1rem;
        padding: 2rem;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      canvas {
        max-width: 800px;
        border: 1px solid #ccc;
      }

      .controls {
        display: flex;
        flex-direction: column;
        gap: 1rem;
        margin: 1rem 0;
      }

      input[type='file'],
      button {
        font-size: 1rem;
        padding: 0.5rem 1rem;
        border: 1px solid #ccc;
        border-radius: 4px;
        background-color: #f8f8f8;
        cursor: pointer;
      }

      label {
        display: block;
        margin-bottom: 0.5rem;
      }

      input[type='range'] {
        width: 200px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Image Ditherer</h1>
      <input type="file" id="fileInput" accept="image/*" />
      <canvas id="canvas"></canvas>
      <div class="controls">
        <div>
          <label for="contrast">Contrast:</label>
          <input
            type="range"
            id="contrast"
            min="-100"
            max="100"
            value="0"
            step="1" />
        </div>
        <div>
          <label for="exposure">Exposure:</label>
          <input
            type="range"
            id="exposure"
            min="-100"
            max="100"
            value="0"
            step="1" />
        </div>
        <div>
          <label for="threshold">Threshold:</label>
          <input
            type="range"
            id="threshold"
            min="0"
            max="100"
            value="50"
            step="1" />
        </div>
      </div>
      <button id="downloadBtn">Download as PNG</button>
    </div>

    <script>
      const fileInput = document.getElementById('fileInput')
      const canvas = document.getElementById('canvas')
      const ctx = canvas.getContext('2d')
      const contrastInput = document.getElementById('contrast')
      const exposureInput = document.getElementById('exposure')
      const thresholdInput = document.getElementById('threshold')
      const downloadBtn = document.getElementById('downloadBtn')

      // Define the 4x4 Bayer matrix pattern similar to your shader
      const bayerMatrix4x4 = [
        0, 14, 3, 13, 11, 6, 8, 5, 12, 2, 15, 1, 7, 10, 4, 9,
      ]

      let image = null

      function adjustPixel(value, contrast, exposure) {
        // Apply exposure
        value += exposure * 255

        // Apply contrast
        const factor = (259 * (contrast + 255)) / (255 * (259 - contrast))
        value = factor * (value - 128) + 128

        return Math.max(0, Math.min(255, value))
      }

      function applyDithering() {
        if (!image) return

        const contrast = parseInt(contrastInput.value) * 2.55
        const exposure = parseFloat(exposureInput.value) / 100
        const threshold = parseFloat(thresholdInput.value) / 100

        // Clear the canvas
        ctx.clearRect(0, 0, canvas.width, canvas.height)

        ctx.drawImage(image, 0, 0, canvas.width, canvas.height)
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height)
        const data = imageData.data

        for (let y = 0; y < canvas.height; y++) {
          for (let x = 0; x < canvas.width; x++) {
            const i = (y * canvas.width + x) * 4

            // Get original color and apply adjustments
            const r = adjustPixel(data[i], contrast, exposure)
            const g = adjustPixel(data[i + 1], contrast, exposure)
            const b = adjustPixel(data[i + 2], contrast, exposure)

            // Convert to grayscale
            const gray = 0.2126 * r + 0.7152 * g + 0.0722 * b

            // Get dither threshold from matrix
            const matrixX = x % 4
            const matrixY = y % 4
            const dither = bayerMatrix4x4[matrixY * 4 + matrixX] / 16.0

            // Apply threshold and dithering
            const normalizedGray = gray / 255
            const ditheredValue = normalizedGray > dither * threshold ? 255 : 0

            data[i] = ditheredValue
            data[i + 1] = ditheredValue
            data[i + 2] = ditheredValue
          }
        }

        ctx.putImageData(imageData, 0, 0)
      }

      fileInput.addEventListener('change', (event) => {
        const file = event.target.files[0]
        image = new Image()
        image.src = URL.createObjectURL(file)
        image.onload = () => {
          // Set canvas size to match image dimensions
          canvas.width = image.width
          canvas.height = image.height
          applyDithering()
        }
      })

      contrastInput.addEventListener('input', applyDithering)
      exposureInput.addEventListener('input', applyDithering)
      thresholdInput.addEventListener('input', applyDithering)

      downloadBtn.addEventListener('click', () => {
        const link = document.createElement('a')
        link.download = 'dithered_image.png'
        link.href = canvas.toDataURL('image/png')
        link.click()
      })
    </script>
  </body>
</html>
